<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Haushaltsbuch</title>
        <style>
:root {
  --bg: #eff2f2;
  --fg: #000000;
  --bg-box: #f5e3f7;
  --acent-color: #0ee3f7; /* bords and stuff */
}

* {
  font-size: clamp(1rem, 2vw, 2rem);
  background-color: var(--bg);
  color: var(--fg);
  font-family: monospace;
}

#info > div, svg {
  background-color: var(--bg-box);
}

body > * {
  margin: 0.5em;
  padding: 0.25em;
  background-color: var(--bg-box);
  border-radius: 8px;
  border: 1px solid var(--acent-color);
}

input,
select,
label,
button,
details {
  padding: 0.25em;
  border-radius: 8px;
}

summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  outline: none;
}


#info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(25ch, 1fr));
}
        </style>
    </head>
    <body>

<form id="menu_export">
  <select id="menu_export_select">
    <option value="server">Server</option>
    <option value="file">File</option>
  </select>
  <button id="menu_enter">Save</button>
</form>
<form id="daily_form">
  <label for="daily_input">€</label>
  <input id="daily_input" type="number" min="0" step="0.01" />
  <select id="daily_label_select"></select>
  <button id="daily_enter">OK</button>
</form>
<div id="info">
  <div id="daily_donut"></div>
  <div id="label_agenda"></div>
</div>
<div id="details"></div>
<script>
// Stolen from: https://github.com/finom/donutjs/blob/master/donut.js
(function (root, factory) {
  if (typeof define === "function" && define.amd) {
    define(factory);
  } else if (typeof module === "object" && module.exports) {
    module.exports = factory();
  } else {
    root.donut = factory();
  }
})(this, function () {
  var doc = document,
    M = Math,
    donutData = {},
    dataIndex = 0,
    donut = function (options) {
      var div = doc.createElement("div"),
        size = options.size || 100,
        data = options.data || [{ value: 1 }],
        weight = options.weight || 50,
        el = options.el,
        r = size / 2,
        PI = M.PI,
        sin = M.sin,
        cos = M.cos,
        sum = 0,
        i,
        value,
        arc,
        setAttribute = function (el, o) {
          for (j in o) {
            el.setAttribute(j, o[j]);
          }
        };

      for (i = 0; i < data.length; i++) {
        sum += data[i].value;
      }

      div.className = "donut";
      div.style.width = div.style.height = size + "px";

      var NS = "http://www.w3.org/2000/svg",
        svg = doc.createElementNS(NS, "svg"),
        startAngle = -PI / 2,
        arcRadius = r - weight / 2;

      svg.setAttribute("height", size + "px");
      svg.setAttribute("width", size + "px");

      div.appendChild(svg);

      for (i = 0; i < data.length; i++) {
        value = data[i].value / sum;
        value = value === 1 ? 0.9999 : value;
        arc = doc.createElementNS(NS, "path");

        var segmentAngle = value * PI * 2,
          endAngle = segmentAngle + startAngle,
          largeArc = (endAngle - startAngle) % (PI * 2) > PI ? 1 : 0,
          startX = r + cos(startAngle) * arcRadius,
          startY = r + sin(startAngle) * arcRadius,
          endX = r + cos(endAngle) * arcRadius,
          endY = r + sin(endAngle) * arcRadius;

        startAngle = endAngle;

        setAttribute(arc, {
          d: [
            "M",
            startX,
            startY,
            "A",
            arcRadius,
            arcRadius,
            0,
            largeArc,
            1,
            endX,
            endY,
          ].join(" "),
          stroke: data[i].color,
          "stroke-width": weight,
          fill: "none",
          "data-name": data[i].name,
          class: "donut-arc",
        });
        donut.data(arc, data[i]);
        //TODO: add agenda
        svg.appendChild(arc);
      }

      if (el) {
        el.appendChild(div);
      }

      return div;
    };

  donut.data = function (arc, data) {
    if (typeof data === "undefined") {
      return donutData[arc._DONUT];
    } else {
      donutData[(arc._DONUT = arc._DONUT || ++dataIndex)] = data;
      return arc;
    }
  };

  return donut;
});
</script>
<script>
const labels = [
  {
    title: "Groceries",
    description: "Food & drinks for home",
    color: "#5f90b0",
    index: 0,
  },
  {
    title: "Dining Out",
    description: "Restaurants, cafés, bars, takeout, delivery",
    color: "#6068af",
    index: 1,
  },
  {
    title: "Housing",
    description: "Rent, utilities, maintenance, repairs",
    color: "#60afa6",
    index: 2,
  },
  {
    title: "Transportation",
    description: "Public transit, fuel, car costs, bike, parking, rideshare",
    color: "#7f62ad",
    index: 3,
  },
  {
    title: "Necessities",
    description:
      "Essential non-food items like cleaning supplies, toiletries, basic clothing",
    color: "#62ad7f",
    index: 4,
  },
  {
    title: "Entertainment",
    description:
      "Electronics, gadgets, entertainment, hobbies, subscriptions, leisure activities",
    color: "#a463ac",
    index: 5,
  },
];

function readableTextColor(hex) {
  // https://www.w3.org/TR/WCAG21/#dfn-relative-luminance
  hex = hex.replace("#", "");

  let r = parseInt(hex.substring(0, 2), 16) / 255;
  let g = parseInt(hex.substring(2, 4), 16) / 255;
  let b = parseInt(hex.substring(4, 6), 16) / 255;

  r = r <= 0.03928 ? r / 12.92 : Math.pow((r + 0.055) / 1.055, 2.4);
  g = g <= 0.03928 ? g / 12.92 : Math.pow((g + 0.055) / 1.055, 2.4);
  b = b <= 0.03928 ? b / 12.92 : Math.pow((b + 0.055) / 1.055, 2.4);

  const L = 0.2126 * r + 0.7152 * g + 0.0722 * b;

  return L > 0.179 ? "#000000" : "#ffffff";
}

window.onload = function () {
  storeCurrentEtag();
  prepareDropDown(labels);
  updateEntries();
};

function storeEtag(response) {
  let etag = response.headers.get("etag");
  console.log("stored", etag);
  localStorage.setItem("etag", etag);
}

function storeCurrentEtag() {
  fetch("/", {
    method: "HEAD",
  })
    .then((response) => {
      if (response.status === 200) {
        storeEtag(response);
      } else {
        console.log("unexpected status", response);
      }
    })
    .catch((error) => {
      console.log("Error:", error);
    });
}

function createAgenda(labels) {
  const container = document.getElementById("label_agenda");
  container.innerHTML = "";
  labels.sort((a, b) => a.value < b.value);

  let createDetail = (label) => {
    const details = document.createElement("details");
    const summary = document.createElement("summary");
    const currency = "€";

    const titleSpan = document.createElement("span");
    titleSpan.textContent = label.title;
    const currencySpan = document.createElement("span");
    currencySpan.textContent = `${label.value.toFixed(2)}${currency}`;
    summary.appendChild(titleSpan);
    summary.appendChild(currencySpan);

    const paragraph = document.createElement("p");
    paragraph.textContent = label.description;

    details.appendChild(summary);
    details.appendChild(paragraph);

    details.classList.add("dynamic-color");
    details.style.setProperty("--bg", label.color);
    details.style.setProperty("--fg", readableTextColor(label.color));
    return details;
  };

  labels.forEach((label) => {
    container.appendChild(createDetail(label));
  });
}

function createEntryTemplate(label, entry) {
  const details = document.createElement("details");

  const titleSpan = document.createElement("span");
  titleSpan.textContent = label.title;
  const currencySpan = document.createElement("span");
  currencySpan.textContent = `${entry.value}${entry.currency}`;

  const summary = document.createElement("summary");
  summary.appendChild(titleSpan);
  summary.appendChild(currencySpan);

  const removeLink = document.createElement("a");
  removeLink.textContent = "remove";
  removeLink.href = "#";
  removeLink.addEventListener("click", function (e) {
    e.preventDefault();
    removeEntry(e, entry.timestamp);
  });

  details.appendChild(summary);
  details.appendChild(removeLink);

  details.style.setProperty("--bg", label.color);
  details.style.setProperty("--fg", readableTextColor(label.color));
  details.setAttribute("entry", JSON.stringify(entry));

  return details;
}

// TODO: maybe do everything event based?
function removeEntry(e, timestamp) {
  const storedData = JSON.parse(localStorage.getItem("dailyEntries")) || [];

  let index = storedData.findIndex((element) => {
    element.timestamp == timestamp;
  });
  if (index > -1) {
    storedData.splice(index, 1);
  } else {
    const newEntry = {
      event: "remove",
      timestamp: timestamp,
    };
    storedData.push(newEntry);
  }

  localStorage.setItem("dailyEntries", JSON.stringify(storedData));
  updateEntries();
}

function convertEmToPx(emValue, context) {
  const fontSize = parseFloat(
    getComputedStyle(context || document.documentElement).fontSize,
  );
  return emValue * fontSize;
}

function prepareDropDown(labels) {
  const details = document.getElementById("daily_label_select");
  details.innerHTML = "";
  labels.forEach((label) => {
    const option = document.createElement("option");
    option.textContent = label.title;
    option.value = label.index;
    details.appendChild(option);
  });
}

function getHTMLEntries(cached) {
  const details = document.getElementById("details").children;
  const results = [];
  for (let i = 0; i < details.length; ++i) {
    let entry = JSON.parse(details[i].getAttribute("entry"));
    if (cached.findIndex((e) => e.timestamp == entry.timestamp) == -1) {
      results.push(entry);
    }
  }

  return results;
}

function updateEntries() {
  const details = document.getElementById("details");
  const cachedData = JSON.parse(localStorage.getItem("dailyEntries")) || [];
  const storedData = getHTMLEntries(cachedData);
  storedData.push(...cachedData);

  //TODO: don't redraw on cachedData.length === 0 but add remove listener
  details.innerHTML = "";
  const prepared_labels = labels.map((label) => {
    label.value = 0;
    return label;
  });
  console.log(storedData);

  const dont_draw = storedData
    .filter((e) => e.event === "remove")
    .map((e) => e.timestamp);
  const drawData = storedData.filter((e) => e.event !== "remove");
  const summaries = drawData.reverse().reduce((p, c) => {
    if (!dont_draw.includes(c.timestamp)) {
      let idx = p.findIndex((item) => item.index === Number(c.label));
      let e = p[idx];
      e.value += Number(c.value);
      const entry = createEntryTemplate(e, c);
      details.appendChild(entry);
      p[idx] = e;
    }
    return p;
  }, prepared_labels);

  createAgenda(summaries);
  const pie_size = convertEmToPx(
    summaries.length * (summaries.length * 0.25 + 0.25),
  );
  const don = donut({
    data: summaries,
    size: pie_size,
    weight: pie_size / 2,
  });
  document.getElementById("daily_donut").innerHTML = don.innerHTML;
}

document
  .getElementById("daily_label_select")
  .addEventListener("change", function () {
    document.getElementById("daily_input").focus();
  });

document.getElementById("daily_form").addEventListener("submit", function () {
  event.preventDefault();
  const value = document.getElementById("daily_input").value;
  const currency = "€";
  const label = document.getElementById("daily_label_select").value;

  if (value && label) {
    const dailyEntries = JSON.parse(localStorage.getItem("dailyEntries")) || [];
    const newEntry = {
      value: Number(value).toFixed(2),
      currency: currency,
      label: label, // index
      timestamp: Math.floor(Date.now() / 1000),
    };
    dailyEntries.push(newEntry);
    localStorage.setItem("dailyEntries", JSON.stringify(dailyEntries));
    document.getElementById("daily_input").value = "";
    document.getElementById("daily_label_select").value = label;
    updateEntries();
  }
  document.getElementById("daily_input").focus();
});

document.getElementById("menu_export").addEventListener("submit", function () {
  event.preventDefault();
  const target = document.getElementById("menu_export_select").value;
  const htmlContent = "<!doctype html>" + document.documentElement.outerHTML;
  console.log("target: ", target);
  if (target === "server") {
    fetch("/", {
      method: "PUT",
      headers: {
        "Content-Type": "text/html",
        "if-match": localStorage.getItem("etag"),
      },
      body: htmlContent,
    })
      .then((response) => {
        storeEtag(response);
        document.innerHTML = response.text();
        if (response.status === 200) {
          localStorage.clear();
        }
      })
      .catch((error) => {
        console.log("Error:", error);
      });
  } else if (target === "file") {
    const blob = new Blob([htmlContent], { type: "text/html" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "ausgabenzettel.html";
    link.click();
    localStorage.clear();
  }
});
</script>
</body>
</html>
